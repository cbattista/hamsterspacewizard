<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Hamster Space Wizard</title>
        <script src="./phaser/phaser.min.js"></script>
    </head>
    <body>

    <script type="text/javascript">



    window.onload = function() {

        var game = new Phaser.Game(800, 600, Phaser.CANVAS, '', { preload: preload, create: create, update: update });

        function preload () {

            game.load.image('space', 'deep-space.jpg');
            game.load.image('hsw', 'hsw.png');
            game.load.image('baddie', 'baddie.png');
            game.load.image('beam', 'bullets.png');
            game.load.image('eyeglow', 'red.png');

            game.load.audio('calm', ['calm.mp3', 'calm.ogg']);


            //  Load the Google WebFont Loader script
            game.load.script('webfont', '//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js');




        }

        var music;

        var hsw;
        var baddie;
        var baddie_label;
        var cursors;
        var tween;

        var one;
        var two;
        var three;
        var four;
        var five;
        var add;
        var sub;

        var operations = ['-', '+', '/', '*'];

        var beam;
        var beams;
        var beam_value = 1;
        var beam_type = '-';
        var beamTime = 0;
        var flipTime = 0;

        function create () {

            //add world bounds
            game.world.setBounds(0, 0, 800, 800);
            game.physics.setBoundsToWorld();

            //game.physics.startSystem(Phaser.Physics.P2JS);

            game.add.tileSprite(0, 0, game.width, game.height, 'space');
            hsw = game.add.sprite(game.world.centerX, game.world.centerY, 'hsw');

            game.camera.follow(hsw);



            music = game.add.audio('calm');
            music.play();


            hsw.anchor.setTo(0.5, 0.5);

            emitter = game.add.emitter(0, -25, 50);
            emitter.makeParticles('eyeglow');

            hsw.addChild(emitter);


            //dialog
            dialog_style = { font: "16px Arial", fill: "#ffff00", align: "center" };
            bvt = game.add.text(12, 16, 'Laser Value:  ' + beam_value, dialog_style);
            bvt.fixedToCamera = true;
            btt = game.add.text(12, 32, 'Laser Type:   ' + beam_type, dialog_style);
            btt.fixedToCamera = true;

            spawn();

            //  hamster physics settings
            game.physics.arcade.enableBody(hsw);
            game.physics.enable(hsw, Phaser.Physics.ARCADE);


            hsw.body.drag.set(100);
            hsw.body.maxVelocity.set(200);

            //  hamster eye beams
            beams = game.add.group();
            beams.enableBody = true;
            beams.physicsBodyType = Phaser.Physics.ARCADE;
            beams.createMultiple(40, 'beam');
            beams.setAll('anchor.x', 0.5);
            beams.setAll('anchor.y', 0.5);


            //  Game input
            cursors = game.input.keyboard.createCursorKeys();
            game.input.keyboard.addKeyCapture([ Phaser.Keyboard.SPACEBAR ]);

            one = game.input.keyboard.addKey([Phaser.Keyboard.ONE]);
            two = game.input.keyboard.addKey([Phaser.Keyboard.TWO]);
            three = game.input.keyboard.addKey([Phaser.Keyboard.THREE]);
            four = game.input.keyboard.addKey([Phaser.Keyboard.FOUR]);
            five = game.input.keyboard.addKey([Phaser.Keyboard.FIVE]);

            add = game.input.keyboard.addKey([Phaser.Keyboard.A]);
            sub = game.input.keyboard.addKey([Phaser.Keyboard.S]);

        }

        function spawn() {
            baddie = game.add.sprite(game.world.randomX, game.world.randomY + 100, 'baddie');
            baddie.anchor.setTo(0.5, 0.5);
            baddie.number = 5;
            var style = { font: "20px Arial", fill: "#ffff00", align: "center" };
            baddie_label = baddie.addChild(game.add.text(-6, -30, baddie.number, style));

            game.physics.arcade.enableBody(baddie);

            game.physics.enable(baddie, Phaser.Physics.ARCADE);
        }

        function update() {

          game.physics.arcade.moveToObject(baddie, hsw);
          //baddie_label.x = baddie.x;
          //baddie_label.y = baddie.y;

          hamster_control();

          beam_control();

          if (game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR))
          {
              fireBeam();
          }

          //  Run collision
          game.physics.arcade.overlap(beams, baddie, collisionHandler, null, this);
        }

        function beam_control() {
            if (one.isDown) {
              beam_value = 1;
            }

            if (two.isDown) {
              beam_value = 2;
            }

            if (three.isDown) {
              beam_value = 3;
            }

            if (four.isDown) {
              beam_value = 4;
            }

            if (five.isDown) {
              beam_value = 5;
            }

            if (add.isDown) {
              beam_type = '+';
            }

            if (sub.isDown) {
              beam_type = '-';
            }

            bvt.text = 'Laser Value:  ' + beam_value;
            btt.text = 'Laser Type:   ' + beam_type;
        }

        function hamster_control() {
          //hamster control
          if (cursors.up.isDown)
          {
              game.physics.arcade.accelerationFromRotation(hsw.rotation+300, 300, hsw.body.acceleration);
          }
          else
          {
              hsw.body.acceleration.set(0);
          }

          if (cursors.left.isDown)
          {
              hsw.body.angularVelocity = -300;
          }
          else if (cursors.right.isDown)
          {
              hsw.body.angularVelocity = 300;
          }
          else if (cursors.down.isDown)
          {
            if (game.time.now > flipTime)
            {
              hsw.anchor.setTo(.5, 1); //so it flips around its middle
              hsw.scale.x = hsw.scale.x * -1; //flip
              hsw.anchor.setTo(.5, .5);
              flipTime = game.time.now + 100;
            }
        }


        else
        {
            hsw.body.angularVelocity = 0;
        }
      }

        function collisionHandler (baddie, bullet) {

            //  When a bullet hits an alien we kill them both

            //console.log(baddie.number);
            baddie.number = eval(baddie.number + beam_type + bullet.number);
            baddie_label.text = baddie.number;
            if (baddie.number == 0) {
              baddie.kill();
              baddie_label.kill();
              spawn();
            }

            bullet.kill();

            //spawn a new baddie

        }


        function fireBeam () {
            if (game.time.now > beamTime)
            {
                beam = beams.getFirstExists(false);

                if (beam)
                {
                    beam.number = beam_value;
                    x_offset = 25 * Math.cos(hsw.rotation + (Math.PI/2));
                    y_offset = 25 * Math.sin(hsw.rotation + (Math.PI/2));

                    hsw.children[0].start(false, 100, frequency=10, quantity=3);

                    beam.reset(hsw.body.x - x_offset + 25, hsw.body.y - y_offset + 50);
                    beam.lifespan = 1000;
                    beam.rotation = hsw.rotation;
                    game.physics.arcade.velocityFromRotation(hsw.rotation, -400 * hsw.scale.x, beam.body.velocity);
                    beamTime = game.time.now + 250;
                }
            }

        }

    };

    </script>

    </body>
</html>
